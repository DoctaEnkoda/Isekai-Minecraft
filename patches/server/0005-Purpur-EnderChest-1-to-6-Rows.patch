From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: William Blake Galbreath <blake.galbreath@gmail.com>
Date: Sun, 21 May 2023 00:08:44 +0200
Subject: [PATCH] Purpur - EnderChest 1 to 6 Rows


diff --git a/src/main/java/fr/euphilia/tenseimc/TenseiConfig.java b/src/main/java/fr/euphilia/tenseimc/TenseiConfig.java
index 526447c3d298706b7f5c18342562a19a3715cc45..9265ca7f76fc3ace51ac69554ea3853ed2042f41 100644
--- a/src/main/java/fr/euphilia/tenseimc/TenseiConfig.java
+++ b/src/main/java/fr/euphilia/tenseimc/TenseiConfig.java
@@ -123,8 +123,22 @@ public class TenseiConfig {
         return builder.build();
     }
 
-    private static void updateConfigVersion() {
+    public static boolean enderChestSixRows = false;
+    public static boolean enderChestPermissionRows = false;
+    private static void blockSettings() {
+        if (version < 2) {
+            enderChestSixRows = getBoolean("settings.blocks.ender_chest.six-rows", enderChestSixRows);
+        }
+        if (version < 2) {
+            enderChestPermissionRows = getBoolean("settings.blocks.ender_chest.use-permissions-for-rows", enderChestPermissionRows);
+        }
+    }
 
+    private static void updateConfigVersion() {
+        if (version >= 2) {
+            set("settings.blocks.ender_chest.six-rows", null);
+            set("settings.blocks.ender_chest.use-permissions-for-rows", null);
+        }
     }
 
     public static boolean useVanillaEndTeleportation = false;
diff --git a/src/main/java/net/minecraft/server/players/PlayerList.java b/src/main/java/net/minecraft/server/players/PlayerList.java
index 9da89e8e9569666227081ebc6cb1f0348e1a183d..04823def9d94a2c2d928cd584b35f168cc750022 100644
--- a/src/main/java/net/minecraft/server/players/PlayerList.java
+++ b/src/main/java/net/minecraft/server/players/PlayerList.java
@@ -1241,6 +1241,27 @@ public abstract class PlayerList {
         player.getBukkitEntity().recalculatePermissions(); // CraftBukkit
         this.server.getCommands().sendCommands(player);
         } // Paper
+
+        // TenseiMC start
+        if (org.purpurmc.purpur.PurpurConfig.enderChestSixRows && org.purpurmc.purpur.PurpurConfig.enderChestPermissionRows) {
+            org.bukkit.craftbukkit.entity.CraftHumanEntity bukkit = player.getBukkitEntity();
+            if (bukkit.hasPermission("tenseimc.enderchest.rows.six") || bukkit.hasPermission("purpur.enderchest.rows.six")) {
+                player.sixRowEnderChestSlotCount = 54;
+            } else if (bukkit.hasPermission("tenseimc.enderchest.rows.five") || bukkit.hasPermission("purpur.enderchest.rows.five")) {
+                player.sixRowEnderChestSlotCount = 45;
+            } else if (bukkit.hasPermission("tenseimc.enderchest.rows.four") || bukkit.hasPermission("purpur.enderchest.rows.four")) {
+                player.sixRowEnderChestSlotCount = 36;
+            } else if (bukkit.hasPermission("tenseimc.enderchest.rows.three") || bukkit.hasPermission("purpur.enderchest.rows.three")) {
+                player.sixRowEnderChestSlotCount = 27;
+            } else if (bukkit.hasPermission("tenseimc.enderchest.rows.two") || bukkit.hasPermission("purpur.enderchest.rows.two")) {
+                player.sixRowEnderChestSlotCount = 18;
+            } else if (bukkit.hasPermission("tenseimc.enderchest.rows.one") || bukkit.hasPermission("purpur.enderchest.rows.one")) {
+                player.sixRowEnderChestSlotCount = 9;
+            }
+        } else {
+            player.sixRowEnderChestSlotCount = -1;
+        }
+        // TenseiMC stop
     }
 
     public boolean isWhiteListed(GameProfile profile) {
diff --git a/src/main/java/net/minecraft/world/entity/player/Player.java b/src/main/java/net/minecraft/world/entity/player/Player.java
index ea52f7b3620249a75cf9619481c90acdf781653e..97efc245e0e1dcbd5ba1c602c0a67dcf403cb7a5 100644
--- a/src/main/java/net/minecraft/world/entity/player/Player.java
+++ b/src/main/java/net/minecraft/world/entity/player/Player.java
@@ -188,6 +188,7 @@ public abstract class Player extends LivingEntity {
     public boolean affectsSpawning = true;
     public net.kyori.adventure.util.TriState flyingFallDamage = net.kyori.adventure.util.TriState.NOT_SET;
     // Paper end
+    public int sixRowEnderChestSlotCount = -1; // TenseiMC
 
     // CraftBukkit start
     public boolean fauxSleeping;
diff --git a/src/main/java/net/minecraft/world/inventory/ChestMenu.java b/src/main/java/net/minecraft/world/inventory/ChestMenu.java
index 0dbfd23bbfc6ad203f048142f8c90ef741849fe1..07d7634482fc611b72ecbc5b8c280153569bf09c 100644
--- a/src/main/java/net/minecraft/world/inventory/ChestMenu.java
+++ b/src/main/java/net/minecraft/world/inventory/ChestMenu.java
@@ -67,10 +67,30 @@ public class ChestMenu extends AbstractContainerMenu {
         return new ChestMenu(MenuType.GENERIC_9x6, syncId, playerInventory, 6);
     }
 
+    // TenseiMC start
+    public static ChestMenu oneRows(int syncId, Inventory playerInventory, Container inventory) {
+        return new ChestMenu(MenuType.GENERIC_9x1, syncId, playerInventory, inventory, 1);
+    }
+
+    public static ChestMenu twoRows(int syncId, Inventory playerInventory, Container inventory) {
+        return new ChestMenu(MenuType.GENERIC_9x2, syncId, playerInventory, inventory, 2);
+    }
+    // TenseiMC end
+
     public static ChestMenu threeRows(int syncId, Inventory playerInventory, Container inventory) {
         return new ChestMenu(MenuType.GENERIC_9x3, syncId, playerInventory, inventory, 3);
     }
 
+    // TenseiMC Start
+    public static ChestMenu fourRows(int syncId, Inventory playerInventory, Container inventory) {
+        return new ChestMenu(MenuType.GENERIC_9x4, syncId, playerInventory, inventory, 4);
+    }
+
+    public static ChestMenu fiveRows(int syncId, Inventory playerInventory, Container inventory) {
+        return new ChestMenu(MenuType.GENERIC_9x5, syncId, playerInventory, inventory, 5);
+    }
+    // TenseiMC Stop
+
     public static ChestMenu sixRows(int syncId, Inventory playerInventory, Container inventory) {
         return new ChestMenu(MenuType.GENERIC_9x6, syncId, playerInventory, inventory, 6);
     }
diff --git a/src/main/java/net/minecraft/world/inventory/PlayerEnderChestContainer.java b/src/main/java/net/minecraft/world/inventory/PlayerEnderChestContainer.java
index 4703f23316f82a1a942907b46d2d6dcb7d70ec37..23d9eb42cdd5b2c4cc0696048865087ab0b27691 100644
--- a/src/main/java/net/minecraft/world/inventory/PlayerEnderChestContainer.java
+++ b/src/main/java/net/minecraft/world/inventory/PlayerEnderChestContainer.java
@@ -30,11 +30,18 @@ public class PlayerEnderChestContainer extends SimpleContainer {
     }
 
     public PlayerEnderChestContainer(Player owner) {
-        super(27);
+        super(org.purpurmc.purpur.PurpurConfig.enderChestSixRows ? 54 : 27); // TenseiMC
         this.owner = owner;
         // CraftBukkit end
     }
 
+    // TenseiMC start
+    @Override
+    public int getContainerSize() {
+        return owner.sixRowEnderChestSlotCount < 0 ? super.getContainerSize() : owner.sixRowEnderChestSlotCount;
+    }
+    // TenseiMC end
+
     public void setActiveChest(EnderChestBlockEntity blockEntity) {
         this.activeChest = blockEntity;
     }
diff --git a/src/main/java/net/minecraft/world/level/block/EnderChestBlock.java b/src/main/java/net/minecraft/world/level/block/EnderChestBlock.java
index 7385e91f32f070e86a4e0fd3d214f55d832c7979..30f23280d1450e6f47570a6b6bf82e171a442a9c 100644
--- a/src/main/java/net/minecraft/world/level/block/EnderChestBlock.java
+++ b/src/main/java/net/minecraft/world/level/block/EnderChestBlock.java
@@ -85,6 +85,32 @@ public class EnderChestBlock extends AbstractChestBlock<EnderChestBlockEntity> i
                 EnderChestBlockEntity enderChestBlockEntity = (EnderChestBlockEntity)blockEntity;
                 playerEnderChestContainer.setActiveChest(enderChestBlockEntity);
                 player.openMenu(new SimpleMenuProvider((syncId, inventory, playerx) -> {
+                    // TenseiMC start
+                    if (org.purpurmc.purpur.PurpurConfig.enderChestSixRows) {
+                        org.bukkit.craftbukkit.entity.CraftHumanEntity bukkitPlayer = player.getBukkitEntity();
+                        if (bukkitPlayer.hasPermission("tenseimc.enderchest.rows.six") || bukkitPlayer.hasPermission("purpur.enderchest.rows.six")) {
+                            player.sixRowEnderChestSlotCount = 54;
+                            return ChestMenu.sixRows(syncId, inventory, playerEnderChestContainer);
+                        } else if (bukkitPlayer.hasPermission("tenseimc.enderchest.rows.five") || bukkitPlayer.hasPermission("purpur.enderchest.rows.five")) {
+                            player.sixRowEnderChestSlotCount = 45;
+                            return ChestMenu.fiveRows(syncId, inventory, playerEnderChestContainer);
+                        } else if (bukkitPlayer.hasPermission("tenseimc.enderchest.rows.four") || bukkitPlayer.hasPermission("purpur.enderchest.rows.four")) {
+                            player.sixRowEnderChestSlotCount = 36;
+                            return ChestMenu.fourRows(syncId, inventory, playerEnderChestContainer);
+                        } else if (bukkitPlayer.hasPermission("tenseimc.enderchest.rows.three") || bukkitPlayer.hasPermission("purpur.enderchest.rows.three")) {
+                            player.sixRowEnderChestSlotCount = 27;
+                            return ChestMenu.threeRows(syncId, inventory, playerEnderChestContainer);
+                        } else if (bukkitPlayer.hasPermission("tenseimc.enderchest.rows.two") || bukkitPlayer.hasPermission("purpur.enderchest.rows.two")) {
+                            player.sixRowEnderChestSlotCount = 18;
+                            return ChestMenu.twoRows(syncId, inventory, playerEnderChestContainer);
+                        } else if (bukkitPlayer.hasPermission("tenseimc.enderchest.rows.one") || bukkitPlayer.hasPermission("purpur.enderchest.rows.one")) {
+                            player.sixRowEnderChestSlotCount = 9;
+                            return ChestMenu.oneRows(syncId, inventory, playerEnderChestContainer);
+                        }
+                        player.sixRowEnderChestSlotCount = -1;
+                        return ChestMenu.sixRows(syncId, inventory, playerEnderChestContainer);
+                    }
+                    // TenseiMC end
                     return ChestMenu.threeRows(syncId, inventory, playerEnderChestContainer);
                 }, CONTAINER_TITLE));
                 player.awardStat(Stats.OPEN_ENDERCHEST);
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftContainer.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftContainer.java
index 633e6f4922ccaf59979a22885162f42c65bf628a..2730e8fd695a9bad0e991fcb98f6127cc895557f 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftContainer.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftContainer.java
@@ -181,6 +181,12 @@ public class CraftContainer extends AbstractContainerMenu {
             case PLAYER:
             case CHEST:
             case ENDER_CHEST:
+                // TenseiMC start
+                this.delegate = new ChestMenu(org.purpurmc.purpur.PurpurConfig.enderChestSixRows ?
+                        MenuType.GENERIC_9x6 : MenuType.GENERIC_9x3, windowId, bottom, top, top.getContainerSize() / 9);
+
+                break;
+                // TenseiMC end
             case BARREL:
                 this.delegate = new ChestMenu(MenuType.GENERIC_9x3, windowId, bottom, top, top.getContainerSize() / 9);
                 break;
diff --git a/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java b/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java
index 471ae4458e7ea7c29d7551b32cec98180fbccd4e..698d64c9a44fc2c62d13072741351119241bd334 100644
--- a/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java
+++ b/src/main/java/org/bukkit/craftbukkit/inventory/CraftInventory.java
@@ -83,7 +83,7 @@ public class CraftInventory implements Inventory {
 
     @Override
     public void setContents(ItemStack[] items) {
-        Preconditions.checkArgument(items.length <= this.getSize(), "Invalid inventory size (%s); expected %s or less", items.length, this.getSize());
+        //Preconditions.checkArgument(items.length <= this.getSize(), "Invalid inventory size (%s); expected %s or less", items.length, this.getSize()); // TenseiMC
 
         for (int i = 0; i < this.getSize(); i++) {
             if (i >= items.length) {
diff --git a/src/main/java/org/purpurmc/purpur/PurpurConfig.java b/src/main/java/org/purpurmc/purpur/PurpurConfig.java
index 4c27b3a153df97dafa206de44b005780f0353986..840aef59f276b25af8a28c99d94906fd0199c232 100644
--- a/src/main/java/org/purpurmc/purpur/PurpurConfig.java
+++ b/src/main/java/org/purpurmc/purpur/PurpurConfig.java
@@ -172,4 +172,18 @@ public class PurpurConfig {
         }
         return builder.build();
     }
+
+    public static boolean enderChestSixRows = false;
+    public static boolean enderChestPermissionRows = false;
+    private static void blockSettings() {
+        if (fr.euphilia.tenseimc.TenseiConfig.version < 2) {
+            enderChestSixRows = fr.euphilia.tenseimc.TenseiConfig.enderChestSixRows;
+            set("settings.blocks.ender_chest.six-rows", enderChestSixRows);
+            enderChestPermissionRows = fr.euphilia.tenseimc.TenseiConfig.enderChestPermissionRows;
+            set("settings.blocks.ender_chest.use-permissions-for-rows", enderChestPermissionRows);
+        }
+        enderChestSixRows = getBoolean("settings.blocks.ender_chest.six-rows", enderChestSixRows);
+        org.bukkit.event.inventory.InventoryType.ENDER_CHEST.setDefaultSize(enderChestSixRows ? 54 : 27);
+        enderChestPermissionRows = getBoolean("settings.blocks.ender_chest.use-permissions-for-rows", enderChestPermissionRows);
+    }
 }
\ No newline at end of file
