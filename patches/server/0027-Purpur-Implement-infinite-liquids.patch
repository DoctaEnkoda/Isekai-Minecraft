From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: William Blake Galbreath <blake.galbreath@gmail.com>
Date: Wed, 2 Aug 2023 13:06:07 +0200
Subject: [PATCH] Purpur - Implement infinite liquids


diff --git a/src/main/java/fr/euphilia/tenseimc/TenseiWorldConfig.java b/src/main/java/fr/euphilia/tenseimc/TenseiWorldConfig.java
index e89985c835b133522e45a9a503fdd41247c0181f..79b055afd96ef2cbc7a79f94793bca126da6b450 100644
--- a/src/main/java/fr/euphilia/tenseimc/TenseiWorldConfig.java
+++ b/src/main/java/fr/euphilia/tenseimc/TenseiWorldConfig.java
@@ -115,6 +115,15 @@ public class TenseiWorldConfig {
         }
     }
 
+    public int lavaInfiniteRequiredSources = 2;
+    public int waterInfiniteRequiredSources = 2;
+    private void liquidsSettings() {
+        if (TenseiConfig.version < 2) {
+            lavaInfiniteRequiredSources = getInt("blocks.lava.infinite-required-sources", lavaInfiniteRequiredSources);
+            waterInfiniteRequiredSources = getInt("blocks.water.infinite-required-sources", waterInfiniteRequiredSources);
+        }
+    }
+
     public boolean beeCanWorkAtNight = false;
     public boolean beeCanWorkInRain = false;
     private void mobsSettings() {
@@ -160,6 +169,8 @@ public class TenseiWorldConfig {
             set("gameplay-mechanics.mob-effects.wither-degeneration-amount", null);
             set("gameplay-mechanics.mob-effects.hunger-exhaustion-amount", null);
             set("gameplay-mechanics.mob-effects.saturation-regen-amount", null);
+            set("blocks.lava.infinite-required-sources", null);
+            set("blocks.water.infinite-required-sources", null);
         }
     }
 
diff --git a/src/main/java/net/minecraft/world/level/material/FlowingFluid.java b/src/main/java/net/minecraft/world/level/material/FlowingFluid.java
index e21f4c5aff3a8e97101f6efc1349fbecf326b5ea..2059c7e22440ef90e2798d89d3855c66852fff06 100644
--- a/src/main/java/net/minecraft/world/level/material/FlowingFluid.java
+++ b/src/main/java/net/minecraft/world/level/material/FlowingFluid.java
@@ -218,7 +218,7 @@ public abstract class FlowingFluid extends Fluid {
             }
         }
 
-        if (this.canConvertToSource(world) && j >= 2) {
+        if (this.canConvertToSource(world) && j >= getRequiredSources(world)) { // TenseiMC
             BlockState iblockdata2 = world.getBlockState(pos.below());
             FluidState fluid1 = iblockdata2.getFluidState();
 
@@ -302,6 +302,12 @@ public abstract class FlowingFluid extends Fluid {
 
     protected abstract boolean canConvertToSource(Level world);
 
+    // TenseiMC start
+    protected int getRequiredSources(Level world) {
+        return 2;
+    }
+    // TenseiMC end
+
     protected void spreadTo(LevelAccessor world, BlockPos pos, BlockState state, Direction direction, FluidState fluidState) {
         if (state.getBlock() instanceof LiquidBlockContainer) {
             ((LiquidBlockContainer) state.getBlock()).placeLiquid(world, pos, state, fluidState);
diff --git a/src/main/java/net/minecraft/world/level/material/LavaFluid.java b/src/main/java/net/minecraft/world/level/material/LavaFluid.java
index c3f8e1e2dd89c168b8b4a15b589109db486bc8d7..a69011353d967aad86268cd654c9271fbcdc839b 100644
--- a/src/main/java/net/minecraft/world/level/material/LavaFluid.java
+++ b/src/main/java/net/minecraft/world/level/material/LavaFluid.java
@@ -198,6 +198,13 @@ public abstract class LavaFluid extends FlowingFluid {
         world.levelEvent(1501, pos, 0);
     }
 
+    // TenseiMC start
+    @Override
+    protected int getRequiredSources(Level world) {
+        return world.purpurConfig.lavaInfiniteRequiredSources;
+    }
+    // TenseiMC end
+
     @Override
     protected boolean canConvertToSource(Level world) {
         return world.getGameRules().getBoolean(GameRules.RULE_LAVA_SOURCE_CONVERSION);
diff --git a/src/main/java/net/minecraft/world/level/material/WaterFluid.java b/src/main/java/net/minecraft/world/level/material/WaterFluid.java
index d280c98aed5262c4ce39526c917de884f25a8584..2ae9f50b7d52b9d4e2659a882c33a82bf08ece08 100644
--- a/src/main/java/net/minecraft/world/level/material/WaterFluid.java
+++ b/src/main/java/net/minecraft/world/level/material/WaterFluid.java
@@ -64,6 +64,13 @@ public abstract class WaterFluid extends FlowingFluid {
         return world.getGameRules().getBoolean(GameRules.RULE_WATER_SOURCE_CONVERSION);
     }
 
+    // TenseiMC start
+    @Override
+    protected int getRequiredSources(Level world) {
+        return world.purpurConfig.waterInfiniteRequiredSources;
+    }
+    // TenseiMC end
+
     // Paper start
     @Override
     protected void beforeDestroyingBlock(LevelAccessor world, BlockPos pos, BlockState state,  BlockPos source) {
diff --git a/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java b/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java
index 17091d0fc991c99daabbb55d9c13fba52db4a76b..498989c4623f737d68fd36da12ed75192124ac8f 100644
--- a/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java
+++ b/src/main/java/org/purpurmc/purpur/PurpurWorldConfig.java
@@ -184,6 +184,14 @@ public class PurpurWorldConfig {
         humanSaturationRegenAmount = (float) getDouble("gameplay-mechanics.mob-effects.saturation-regen-amount", humanSaturationRegenAmount);
     }
 
+    public int lavaInfiniteRequiredSources = 2;
+    private void lavaSettings() {
+        if (TenseiConfig.version < 2) {
+            lavaInfiniteRequiredSources = this.tenseiWorldConfig.lavaInfiniteRequiredSources;
+        }
+        lavaInfiniteRequiredSources = getInt("blocks.lava.infinite-required-sources", lavaInfiniteRequiredSources);
+    }
+
     public double playerCriticalDamageMultiplier = 1.5D;
     private void playerSettings() {
         if (TenseiConfig.version < 2) {
@@ -192,4 +200,13 @@ public class PurpurWorldConfig {
         }
         playerCriticalDamageMultiplier = getDouble("gameplay-mechanics.player.critical-damage-multiplier", playerCriticalDamageMultiplier);
     }
+
+    public int waterInfiniteRequiredSources = 2;
+    private void waterSources() {
+        if (TenseiConfig.version < 2) {
+            waterInfiniteRequiredSources = this.tenseiWorldConfig.waterInfiniteRequiredSources;
+            set("blocks.water.infinite-required-sources", waterInfiniteRequiredSources);
+        }
+        waterInfiniteRequiredSources = getInt("blocks.water.infinite-required-sources", waterInfiniteRequiredSources);
+    }
 }
\ No newline at end of file
